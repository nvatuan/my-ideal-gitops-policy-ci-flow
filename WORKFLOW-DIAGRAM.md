# Workflow Execution Flow

## Complete Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Pull Request                             â”‚
â”‚  Changes to: manifests/services/** or policies/**               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  P01: KUSTOMIZE BUILD                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Job 1: detect-changes                                  â”‚    â”‚
â”‚  â”‚  - Parse git diff                                       â”‚    â”‚
â”‚  â”‚  - Extract service names                                â”‚    â”‚
â”‚  â”‚  - Generate matrix: services Ã— environments            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                             â”‚                                    â”‚
â”‚                             â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Job 2: build-before-after (matrix)                    â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚my-app/stgâ”‚ â”‚my-app/prdâ”‚ â”‚my-app/sbxâ”‚ â”‚  ...     â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚  Each builds:                                           â”‚    â”‚
â”‚  â”‚  - Checkout PR branch â†’ kustomize build â†’ AFTER        â”‚    â”‚
â”‚  â”‚  - Checkout base branch â†’ kustomize build â†’ BEFORE     â”‚    â”‚
â”‚  â”‚  - Upload both as artifacts                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                             â”‚                                    â”‚
â”‚                             â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Job 3: build-complete                                  â”‚    â”‚
â”‚  â”‚  - Verify all builds succeeded                         â”‚    â”‚
â”‚  â”‚  - Artifacts ready for P02 workflows                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ workflow_run trigger
                             â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                                     â”‚
          â–¼                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ P02: DIFF COMMENTER     â”‚         â”‚ P02: POLICY EVAL        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Download artifacts  â”‚ â”‚         â”‚ â”‚ Download artifacts  â”‚ â”‚
â”‚ â”‚ - before/*.yaml     â”‚ â”‚         â”‚ â”‚ - after/*.yaml only â”‚ â”‚
â”‚ â”‚ - after/*.yaml      â”‚ â”‚         â”‚ â”‚                     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚             â”‚         â”‚           â”‚             â”‚
â”‚           â–¼             â”‚         â”‚           â–¼             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Generate diffs      â”‚ â”‚         â”‚ â”‚ Parse policies      â”‚ â”‚
â”‚ â”‚ - Unified diff      â”‚ â”‚         â”‚ â”‚ - compliance-config â”‚ â”‚
â”‚ â”‚ - Summary table     â”‚ â”‚         â”‚ â”‚ - Determine levels  â”‚ â”‚
â”‚ â”‚ - Statistics        â”‚ â”‚         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚           â”‚             â”‚
â”‚           â”‚             â”‚         â”‚           â–¼             â”‚
â”‚           â–¼             â”‚         â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”‚ â”‚ Job: blocking       â”‚ â”‚
â”‚ â”‚ Post PR comment     â”‚ â”‚         â”‚ â”‚ - BLOCKING only     â”‚ â”‚
â”‚ â”‚ ğŸ“Š Manifest Changes â”‚ â”‚         â”‚ â”‚ - Required check    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚ â”‚ - Fail if violationsâ”‚ â”‚
â”‚                         â”‚         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚           â”‚             â”‚
                                    â”‚           â–¼             â”‚
                                    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                                    â”‚ â”‚ Job: advisory       â”‚ â”‚
                                    â”‚ â”‚ - All levels        â”‚ â”‚
                                    â”‚ â”‚ - Continue on error â”‚ â”‚
                                    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                                    â”‚           â”‚             â”‚
                                    â”‚           â–¼             â”‚
                                    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                                    â”‚ â”‚ Job: report         â”‚ â”‚
                                    â”‚ â”‚ - Generate markdown â”‚ â”‚
                                    â”‚ â”‚ - Post PR comment   â”‚ â”‚
                                    â”‚ â”‚ ğŸ” Policy Report    â”‚ â”‚
                                    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Pull Request Comments                       â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“Š Manifest Changes                                             â”‚
â”‚  - my-app/stg: âœï¸ Modified (+5 -2)                              â”‚
â”‚  - my-app/prod: ğŸ†• New (+210 -0)                                â”‚
â”‚  - Details... (click to expand)                                 â”‚
â”‚                                                                  â”‚
â”‚  ğŸ” Policy Compliance Report                                     â”‚
â”‚  Status: âš ï¸ WARNING                                              â”‚
â”‚  Summary: 4/5 checks passed                                      â”‚
â”‚  - âš ï¸ Warning: HA policy failed for sandbox                     â”‚
â”‚  - Details... (click to expand)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Execution Timeline

```
Time    P01             P02-Diff        P02-Policy
â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0s      Start
        detect-changes
1s      
2s      build-matrix
        [stg][prod]
        [sandbox]
3s      
30s     All builds âœ“
        build-complete
        Upload artifacts
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Start           Start
35s                     Download        Download
                        artifacts       artifacts
40s                     Generate        Parse config
                        diff            Run OPA eval
50s                     Post comment âœ“  blocking: âœ“
                                        advisory: âœ“
55s                                     Generate report
60s                                     Post comment âœ“
```

## Artifact Flow

```
P01 Output Artifacts:
â”œâ”€â”€ before-my-app-stg.yaml      (157 KB)
â”œâ”€â”€ before-my-app-prod.yaml     (165 KB)
â”œâ”€â”€ before-my-app-sandbox.yaml  (145 KB)
â”œâ”€â”€ after-my-app-stg.yaml       (159 KB)
â”œâ”€â”€ after-my-app-prod.yaml      (168 KB)
â””â”€â”€ after-my-app-sandbox.yaml   (146 KB)

       â”‚                    â”‚
       â”‚                    â”‚
       â–¼                    â–¼
P02-Diff uses           P02-Policy uses
ALL artifacts           AFTER artifacts only
(before + after)        (current state)

       â”‚                    â”‚
       â–¼                    â–¼
Diff report             Policy results
(markdown)              (JSON â†’ markdown)
```

## Data Processing Flow

```
Kustomize Build (P01):
base/deployment.yaml
  + environments/stg/deployment-patch.yaml
  = stg-deployment.yaml (artifact)

Diff Generation (P02-Diff):
before/my-app-stg.yaml
  vs
after/my-app-stg.yaml
  â†’ unified diff
  â†’ markdown report

Policy Evaluation (P02-Policy):
after/my-app-stg.yaml
  â†’ split into resources
  â†’ for each resource:
    - Deployment/my-app
    - Service/my-app  
    - Ingress/my-app
  â†’ evaluate against policies:
    - ha.opa
    - ingress-tls.opa
  â†’ aggregate results
  â†’ markdown report
```

## Parallelization Benefits

```
Sequential (old):
[Detect][Build][Diff][Policy] = 60s total

Parallel (new):
[Detect][Build]
            â””â”€â”€[Diff  ] = 30s
            â””â”€â”€[Policy] = 30s
Total: 40s (33% faster)

With 3x services:
Sequential: 180s
Parallel: 
  [Detect][Build matrix 3Ã—3]
              â””â”€â”€[Diff  ] = 30s
              â””â”€â”€[Policy] = 30s
Total: 60s (66% faster)
```

## Error Handling

```
Build fails:
  P01: build-complete fails âŒ
  P02: Don't trigger (workflow_run checks success)
  Result: No artifacts, no comments

Diff fails:
  P01: Success âœ“
  P02-Diff: Fails âŒ
  P02-Policy: Still runs âœ“ (independent)
  Result: No diff comment, but policy report posted

Policy blocking fails:
  P01: Success âœ“
  P02-Diff: Success âœ“
  P02-Policy: blocking job fails âŒ, advisory continues
  Result: PR blocked, both comments posted

Policy advisory fails:
  P01: Success âœ“
  P02-Diff: Success âœ“  
  P02-Policy: advisory job fails (continue-on-error), report still posts âœ“
  Result: PR not blocked, both comments posted
```
